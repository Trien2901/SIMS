<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản trị Hệ thống</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #admin-view, #login-view { display: none; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translate(-50%, 40px); padding: 12px 24px;
            border-radius: 8px; color: white; z-index: 1050;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }
        .toast.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }
    </style>
</head>
<body onload="initApp()">

    <div id="login-view" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h1 class="text-3xl font-bold text-center text-violet-700 mb-6">Đăng nhập Admin</h1>
            <input type="text" id="username" placeholder="Tên đăng nhập" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-violet-500 focus:border-violet-500">
            <input type="password" id="password" placeholder="Mật khẩu" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-violet-500 focus:border-violet-500">
            <button onclick="login()" class="w-full bg-violet-600 text-white p-3 rounded-lg font-semibold hover:bg-violet-700 transition duration-300">Đăng nhập</button>
        </div>
    </div>

    <div id="admin-view"></div>
    
    <div id="toast" class="toast"></div>

    <div id="assign-class-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full justify-center items-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Phân Lớp cho Sinh viên</h3>
            <div id="modal-student-info" class="mb-4 text-sm"></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-1">Khoa (Chuyên ngành):</label>
                    <p id="student-major-info" class="w-full p-2 bg-gray-100 rounded-lg"></p>
                </div>
                <div>
                    <label for="homeroom-class-select" class="block text-sm font-medium text-gray-700 mb-1">Chọn Lớp sinh hoạt:</label>
                    <select id="homeroom-class-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeAssignClassModal()" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Hủy</button>
                <button id="modal-save-btn" class="px-5 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">Lưu thay đổi</button>
            </div>
        </div>
    </div>
    <div id="student-status-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full justify-center items-center z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Cập nhật Trạng thái Sinh viên</h3>
            <div id="status-modal-student-info" class="mb-4"></div>
            <div>
                <label for="status-select" class="block text-sm font-medium text-gray-700 mb-1">Chọn trạng thái mới:</label>
                <select id="status-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeStatusModal()" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Hủy</button>
                <button id="status-modal-save-btn" class="px-5 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <script>
        // --- MOCK DATA ---
        let MOCK_DATA = {
            roles: { 'admin': 'admin' },
            students: { 
                'SV001': { name: 'Nguyễn Văn An', studentId: 'SV001', major: 'Công nghệ thông tin', course: 'K45', email: 'an.nv@sism.edu.vn', studentClass: 'CNTT K45A', status: 'Đang học' },
                'SV002': { name: 'Trần Thị Bích', studentId: 'SV002', major: 'Quản trị kinh doanh', course: 'K45', email: 'bich.tt@sism.edu.vn', studentClass: 'QTKD K45', status: 'Đang học' },
                'SV003': { name: 'Lê Văn Cường', studentId: 'SV003', major: 'Công nghệ thông tin', course: 'K45', email: 'cuong.lv@sism.edu.vn', studentClass: 'CNTT K45B', status: 'Bảo lưu' },
                'SV004': { name: 'Phạm Thị Duyên', studentId: 'SV004', major: 'Ngôn ngữ Anh', course: 'K44', email: 'duyen.pt@sism.edu.vn', studentClass: 'NNA K44', status: 'Thôi học' },
                'SV005': { name: 'Hoàng Văn Em', studentId: 'SV005', major: 'Công nghệ thông tin', course: 'K46', email: 'em.hv@sism.edu.vn', studentClass: null, status: 'Đang học' },
            },
            lecturers: {
                'GV001': { id: 'GV001', name: 'Trần Thị E', department: 'Khoa Công nghệ thông tin', email: 'e.tt@sism.edu.vn', phone: '0912345678' },
                'GV002': { id: 'GV002', name: 'Nguyễn Minh Hùng', department: 'Khoa Kinh tế', email: 'hung.nm@sism.edu.vn', phone: '0987654321' },
                'GV003': { id: 'GV003', name: 'Lê Thu Hà', department: 'Khoa Ngoại ngữ', email: 'ha.lt@sism.edu.vn', phone: '0911223344' },
            },
            availableClasses: [
                { id: 'CL001', subject: 'Cấu trúc dữ liệu và giải thuật', lecturerId: 'GV001', time: 'Thứ 3, 9:00-11:00', room: 'A1-203', registered: 35, max: 40 },
                { id: 'CL002', subject: 'Kinh tế vĩ mô', lecturerId: 'GV002', time: 'Thứ 2, 7:00-9:00', room: 'C2-201', registered: 40, max: 40 },
                { id: 'CL003', subject: 'Tiếng Anh giao tiếp', lecturerId: null, time: 'Thứ 4, 13:00-15:00', room: 'B2-101', registered: 15, max: 30 },
            ],
            departmentClasses: {
                'Công nghệ thông tin': ['CNTT K46A', 'CNTT K46B', 'CNTT K46C'],
                'Quản trị kinh doanh': ['QTKD K46A', 'QTKD K46B'],
                'Ngôn ngữ Anh': ['NNA K46A']
            },
            announcements: [
                { id: 1, title: 'Thông báo nghỉ lễ 30/4 - 1/5', content: 'Toàn thể sinh viên được nghỉ lễ...', date: '25/04/2024' },
                { id: 2, title: 'Lịch thi cuối kỳ', content: 'Lịch thi chi tiết đã được cập nhật...', date: '20/04/2024' },
            ],
            studentStatuses: ['Đang học', 'Bảo lưu', 'Thôi học']
        };

        let chartInstance = null;

        // --- CORE FUNCTIONS ---
        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            toast.style.backgroundColor = isSuccess ? '#10B981' : '#EF4444';
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function initApp() {
            document.getElementById('login-view').style.display = 'flex';
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (MOCK_DATA.roles[username] === password && username === 'admin') {
                document.getElementById('login-view').style.display = 'none';
                setupAdminUI();
                document.getElementById('admin-view').style.display = 'block';
                switchContent('admin-dashboard');
                showToast('Đăng nhập thành công!', true);
            } else {
                showToast('Sai tên đăng nhập hoặc mật khẩu.', false);
            }
        }

        function logout() {
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
            document.getElementById('admin-view').style.display = 'none';
            document.getElementById('login-view').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function switchContent(targetId) {
            const wrapper = document.getElementById('admin-view');
            wrapper.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            const targetSection = wrapper.querySelector(`#${targetId}`);
            if (targetSection) targetSection.classList.add('active');
            
            wrapper.querySelectorAll('header nav a').forEach(link => {
                const isActive = link.dataset.target === targetId;
                link.classList.toggle('text-violet-600', isActive);
                link.classList.toggle('border-violet-600', isActive);
                link.classList.toggle('font-semibold', isActive);
                link.classList.toggle('text-gray-500', !isActive);
                link.classList.toggle('border-transparent', !isActive);
            });

            if (targetId === 'admin-dashboard') {
                renderAdminDashboardCharts();
            }
        }

        // --- ADMIN UI SETUP ---
        function setupAdminUI() {
            const wrapper = document.getElementById('admin-view');
            
            const studentList = Object.values(MOCK_DATA.students);
            const lecturerList = Object.values(MOCK_DATA.lecturers);
            const uniqueMajors = [...new Set(studentList.map(s => s.major))];
            const uniqueCourses = [...new Set(studentList.map(s => s.course))].filter(Boolean);
            const uniqueDepartments = [...new Set(lecturerList.map(l => l.department))];

            const tpl = {
                header: `...`,
                content: `
                    <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
                        <div id="admin-dashboard" class="content-section"></div>
                        <div id="admin-students" class="content-section"></div>
                        <div id="admin-lecturers" class="content-section"></div>
                        <div id="admin-teaching-assignment" class="content-section"></div>
                        <div id="admin-announcements" class="content-section"></div>
                    </main>`
            };
            
            tpl.header = `
                <header class="bg-white shadow-sm sticky top-0 z-40">
                     <div class="bg-slate-800 text-white"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-14">
                        <div class="flex items-center space-x-4"><div class="bg-white rounded-md p-1">
                            <svg class="h-6 w-6 text-violet-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" /></svg>
                        </div><span class="font-semibold text-lg">Trang Quản trị viên</span></div>
                        <div class="flex items-center space-x-6"><div class="flex items-center space-x-2"><img class="h-9 w-9 rounded-full" src="https://i.pravatar.cc/150?u=admin" alt="Avatar"><span>Admin</span></div><button onclick="logout()" class="text-sm bg-red-500 text-white px-3 py-1.5 rounded-md hover:bg-red-600 transition">Đăng xuất</button></div>
                    </div></div>
                     <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div id="admin-main-nav" class="flex space-x-4 h-14 items-center">
                        <a href="#" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-target="admin-dashboard">Dashboard</a>
                        <a href="#" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-target="admin-students">Quản lý Sinh viên</a>
                        <a href="#" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-target="admin-lecturers">Quản lý Giảng viên</a>
                        <a href="#" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-target="admin-teaching-assignment">Phân công Giảng dạy</a>
                        <a href="#" class="inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium" data-target="admin-announcements">Thông báo</a>
                    </div></nav>
                </header>`;

            wrapper.innerHTML = tpl.header + tpl.content;

            // --- Fill Content Sections ---
            
            wrapper.querySelector('#admin-dashboard').innerHTML = `
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Tổng quan hệ thống</h1>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-600">Tổng số Sinh viên</h3><p class="text-4xl font-bold text-violet-700 mt-2">${Object.keys(MOCK_DATA.students).length}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-600">Tổng số Giảng viên</h3><p class="text-4xl font-bold text-green-700 mt-2">${Object.keys(MOCK_DATA.lecturers).length}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-gray-600">Tổng số Lớp học</h3><p class="text-4xl font-bold text-amber-700 mt-2">${MOCK_DATA.availableClasses.length}</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                     <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Hành động nhanh</h2>
                        <div class="flex space-x-4">
                            <button onclick="alert('Mở form thêm sinh viên!')" class="bg-violet-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-violet-700">Thêm Sinh viên mới</button>
                            <button onclick="switchContent('admin-announcements')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700">Tạo Thông báo</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Phân bố sinh viên theo Chuyên ngành</h2>
                        <div class="relative h-64 md:h-80"><canvas id="majorChart"></canvas></div>
                    </div>
                </div>`;
                
            wrapper.querySelector('#admin-students').innerHTML = `
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-900">Quản lý Sinh viên</h2><button class="bg-violet-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-violet-700">Thêm Sinh viên</button></div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input id="student-search" type="text" placeholder="Tìm kiếm theo tên, mã SV..." class="w-full p-2 border rounded-lg md:col-span-1">
                        <select id="major-filter" class="w-full p-2 border rounded-lg"><option value="">Tất cả các ngành</option>${uniqueMajors.map(m => `<option value="${m}">${m}</option>`).join('')}</select>
                        <select id="course-filter" class="w-full p-2 border rounded-lg"><option value="">Tất cả các khóa</option>${uniqueCourses.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                        <select id="status-filter" class="w-full p-2 border rounded-lg"><option value="">Tất cả trạng thái</option>${MOCK_DATA.studentStatuses.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left">
                       <thead><tr class="bg-gray-100"><th class="p-3">Mã SV</th><th class="p-3">Họ tên</th><th class="p-3">Lớp SH</th><th class="p-3">Trạng thái</th><th class="p-3">Hành động</th></tr></thead>
                       <tbody id="student-table-body"></tbody>
                    </table></div>
                </div>`;
            
            wrapper.querySelector('#admin-lecturers').innerHTML = `
                 <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-900">Quản lý Giảng viên</h2><button class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700">Thêm Giảng viên</button></div>
                 <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input id="lecturer-search" type="text" placeholder="Tìm kiếm giảng viên..." class="w-full p-2 border rounded-lg">
                        <select id="department-filter" class="w-full p-2 border rounded-lg"><option value="">Tất cả các khoa</option>${uniqueDepartments.map(d => `<option value="${d}">${d}</option>`).join('')}</select>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left">
                       <thead><tr class="bg-gray-100"><th class="p-3">Họ tên</th><th class="p-3">Khoa</th><th class="p-3">Email</th><th class="p-3">Số ĐT</th><th class="p-3">Hành động</th></tr></thead>
                       <tbody id="lecturer-table-body"></tbody>
                    </table></div>
                </div>`;
            
            wrapper.querySelector('#admin-teaching-assignment').innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Phân công Giảng dạy</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto"><table class="w-full text-left">
                       <thead><tr class="bg-gray-100"><th class="p-3">Môn học</th><th class="p-3">Lịch học</th><th class="p-3 w-1/3">Giảng viên phụ trách</th><th class="p-3">Hành động</th></tr></thead>
                       <tbody id="assignment-table-body"></tbody>
                    </table></div>
                </div>`;
            
            wrapper.querySelector('#admin-announcements').innerHTML = `
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Quản lý Thông báo</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Tạo thông báo mới</h3>
                        <input type="text" placeholder="Tiêu đề thông báo" class="w-full p-2 mb-3 border rounded-lg">
                        <textarea placeholder="Nội dung thông báo..." rows="5" class="w-full p-2 mb-3 border rounded-lg"></textarea>
                        <button class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700">Đăng thông báo</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Các thông báo đã đăng</h3>
                        <div class="space-y-4">
                        ${MOCK_DATA.announcements.map(a => `
                            <div class="border p-4 rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div><p class="font-bold">${a.title}</p><p class="text-sm text-gray-500">${a.date}</p></div>
                                    <button class="text-red-500 hover:underline text-sm">Xóa</button>
                                </div>
                                <p class="mt-2 text-gray-700">${a.content}</p>
                            </div>
                        `).join('')}
                        </div>
                    </div>
                </div>`;

            renderStudentTable(studentList);
            renderLecturerTable(lecturerList);
            renderAssignmentTable();
            
            wrapper.querySelectorAll('header nav a').forEach(link => { link.addEventListener('click', e => { e.preventDefault(); switchContent(e.currentTarget.dataset.target); }); });
            document.getElementById('student-search').addEventListener('input', applyStudentFilters);
            document.getElementById('major-filter').addEventListener('change', applyStudentFilters);
            document.getElementById('course-filter').addEventListener('change', applyStudentFilters);
            document.getElementById('status-filter').addEventListener('change', applyStudentFilters);
            document.getElementById('lecturer-search').addEventListener('input', applyLecturerFilters);
            document.getElementById('department-filter').addEventListener('change', applyLecturerFilters);
        }
        
        // --- Render and Filter Functions ---
        function getStatusBadge(status) {
            switch(status) {
                case 'Đang học': return `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">${status}</span>`;
                case 'Bảo lưu': return `<span class="px-2 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">${status}</span>`;
                case 'Thôi học': return `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">${status}</span>`;
                default: return `<span class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 rounded-full">Không rõ</span>`;
            }
        }
        
        function renderStudentTable(students) {
            const tableBody = document.getElementById('student-table-body');
            if (!tableBody) return;
            if (students.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">Không tìm thấy sinh viên nào.</td></tr>`;
                return;
            }
            tableBody.innerHTML = students.map(s => `
                <tr class="border-b">
                    <td class="p-3">${s.studentId}</td><td class="p-3">${s.name}</td>
                    <td class="p-3">${s.studentClass || '<span class="text-gray-400">Chưa có</span>'}</td>
                    <td class="p-3">${getStatusBadge(s.status)}</td>
                    <td class="p-3 whitespace-nowrap">
                        <button onclick="openStatusModal('${s.studentId}')" class="text-blue-500 hover:underline">Cập nhật</button> 
                        <button onclick="openAssignClassModal('${s.studentId}')" class="text-green-500 hover:underline ml-2">Phân lớp</button>
                    </td>
                </tr>
            `).join('');
        }

        function applyStudentFilters() {
            const searchTerm = document.getElementById('student-search').value.toLowerCase();
            const selectedMajor = document.getElementById('major-filter').value;
            const selectedCourse = document.getElementById('course-filter').value;
            const selectedStatus = document.getElementById('status-filter').value;
            let filteredStudents = Object.values(MOCK_DATA.students);

            if (searchTerm) { filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchTerm) || s.studentId.toLowerCase().includes(searchTerm)); }
            if (selectedMajor) { filteredStudents = filteredStudents.filter(s => s.major === selectedMajor); }
            if (selectedCourse) { filteredStudents = filteredStudents.filter(s => s.course === selectedCourse); }
            if (selectedStatus) { filteredStudents = filteredStudents.filter(s => s.status === selectedStatus); }
            renderStudentTable(filteredStudents);
        }
        
        function renderLecturerTable(lecturers) {
            const tableBody = document.getElementById('lecturer-table-body');
            if (!tableBody) return;
            if (lecturers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">Không tìm thấy giảng viên nào.</td></tr>`;
                return;
            }
            tableBody.innerHTML = lecturers.map(l => `
                <tr class="border-b"><td class="p-3">${l.name}</td><td class="p-3">${l.department}</td><td class="p-3">${l.email}</td><td class="p-3">${l.phone}</td><td class="p-3"><button class="text-blue-500 hover:underline">Sửa</button> <button class="text-red-500 hover:underline ml-2">Xóa</button></td></tr>
            `).join('');
        }

        function applyLecturerFilters() {
            const searchTerm = document.getElementById('lecturer-search').value.toLowerCase();
            const selectedDepartment = document.getElementById('department-filter').value;
            let filteredLecturers = Object.values(MOCK_DATA.lecturers);

            if (searchTerm) { filteredLecturers = filteredLecturers.filter(l => l.name.toLowerCase().includes(searchTerm) || l.email.toLowerCase().includes(searchTerm)); }
            if (selectedDepartment) { filteredLecturers = filteredLecturers.filter(l => l.department === selectedDepartment); }
            renderLecturerTable(filteredLecturers);
        }
        
        function renderAssignmentTable() {
            const tableBody = document.getElementById('assignment-table-body');
            if (!tableBody) return;
            const allLecturers = Object.values(MOCK_DATA.lecturers);
            tableBody.innerHTML = MOCK_DATA.availableClasses.map(cls => {
                const lecturerOptions = allLecturers.map(l => `<option value="${l.id}" ${cls.lecturerId === l.id ? 'selected' : ''}>${l.name} (${l.department})</option>`).join('');
                return `
                    <tr class="border-b">
                        <td class="p-3">${cls.subject}</td><td class="p-3">${cls.time} - ${cls.room}</td>
                        <td class="p-3"><select id="lecturer-for-${cls.id}" class="w-full p-2 border rounded-lg"><option value="">-- Chưa phân công --</option>${lecturerOptions}</select></td>
                        <td class="p-3"><button onclick="saveAssignment('${cls.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600">Lưu</button></td>
                    </tr>`;
            }).join('');
        }

        function saveAssignment(classId) {
            const selectElement = document.getElementById(`lecturer-for-${classId}`);
            const newLecturerId = selectElement.value || null;
            const classIndex = MOCK_DATA.availableClasses.findIndex(c => c.id === classId);
            if (classIndex !== -1) {
                MOCK_DATA.availableClasses[classIndex].lecturerId = newLecturerId;
                showToast(`Đã cập nhật phân công cho lớp ${classId}!`, true);
                renderAssignmentTable();
            }
        }

        function openAssignClassModal(studentId) {
            const modal = document.getElementById('assign-class-modal');
            const student = MOCK_DATA.students[studentId];
            if (!student || !student.major) {
                showToast('Sinh viên này chưa có thông tin Khoa/Ngành!', false);
                return;
            };

            document.getElementById('modal-student-info').innerHTML = `
                <p><span class="font-semibold">Mã SV:</span> ${student.studentId}</p>
                <p><span class="font-semibold">Họ tên:</span> ${student.name}</p>
            `;
            
            document.getElementById('student-major-info').textContent = student.major;
            
            const classSelect = document.getElementById('homeroom-class-select');
            const classesForMajor = MOCK_DATA.departmentClasses[student.major] || [];
            classSelect.innerHTML = `<option value="">-- Chọn Lớp --</option>` + classesForMajor.map(cls => `<option value="${cls}" ${student.studentClass === cls ? 'selected' : ''}>${cls}</option>`).join('');

            document.getElementById('modal-save-btn').onclick = () => saveStudentClassAssignment(studentId);
            modal.classList.add('active');
        }

        function closeAssignClassModal() {
            document.getElementById('assign-class-modal').classList.remove('active');
        }

        function saveStudentClassAssignment(studentId) {
            const newClass = document.getElementById('homeroom-class-select').value;
            if (!newClass) {
                showToast('Vui lòng chọn một lớp!', false);
                return;
            }
            MOCK_DATA.students[studentId].studentClass = newClass;
            showToast(`Đã phân lớp cho sinh viên ${studentId} thành công!`, true);
            closeAssignClassModal();
            applyStudentFilters(); 
        }
        
        function openStatusModal(studentId) {
            const modal = document.getElementById('student-status-modal');
            const student = MOCK_DATA.students[studentId];
            if (!student) return;
            document.getElementById('status-modal-student-info').innerHTML = `<p><span class="font-semibold">Mã SV:</span> ${student.studentId}</p><p><span class="font-semibold">Họ tên:</span> ${student.name}</p><p class="mt-2"><span class="font-semibold">Trạng thái hiện tại:</span> ${getStatusBadge(student.status)}</p>`;
            const selectEl = document.getElementById('status-select');
            selectEl.innerHTML = MOCK_DATA.studentStatuses.map(s => `<option value="${s}" ${student.status === s ? 'selected' : ''}>${s}</option>`).join('');
            document.getElementById('status-modal-save-btn').onclick = () => saveStudentStatus(studentId);
            modal.classList.add('active');
        }

        function closeStatusModal() {
            document.getElementById('student-status-modal').classList.remove('active');
        }

        function saveStudentStatus(studentId) {
            const newStatus = document.getElementById('status-select').value;
            MOCK_DATA.students[studentId].status = newStatus;
            showToast(`Đã cập nhật trạng thái cho SV ${studentId}!`, true);
            closeStatusModal();
            applyStudentFilters(); 
        }

        function renderAdminDashboardCharts() {
            setTimeout(() => {
                const canvas = document.getElementById('majorChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (chartInstance) {
                    chartInstance.destroy();
                }
                const studentData = Object.values(MOCK_DATA.students);
                const majors = studentData.reduce((acc, student) => {
                    acc[student.major] = (acc[student.major] || 0) + 1;
                    return acc;
                }, {});
                chartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(majors),
                        datasets: [{
                            data: Object.values(majors),
                            backgroundColor: ['#8B5CF6', '#10B981', '#F59E0B', '#3B82F6'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }, 100);
        }

    </script>
</body>
</html>